<!DOCTYPE html>
<html lang="zh-TW" class="scroll-smooth">
<head>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="東京富士旅">
    
    <title>東京富士冬日旅 2025</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        fuji: '#2C5F8A', snow: '#FFFFFF', warm: '#F4F6F8', accent: '#E65D5D',
                        tagFood: '#F4A261', tagShop: '#E76F51', tagSpot: '#2A9D8F',
                        tagHotel: '#457B9D', tagTrans: '#8D99AE', tagPlay: '#E9C46A',
                        darkBg: '#1a1b1e', darkCard: '#25262b', darkText: '#c1c2c5',
                        // 計算機按鈕色
                        calcNum: '#ffffff', calcNumDark: '#2c2e33',
                        calcOp: '#ffedd5', calcOpDark: '#431407', // 橘色系運算符
                        calcFunc: '#e2e8f0', calcFuncDark: '#374151' // 功能鍵
                    },
                    fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { -webkit-font-smoothing: antialiased; padding-bottom: 120px; background-color: #F4F6F8; }
        .dark body { background-color: #1a1b1e; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .card-shadow { box-shadow: 0 4px 20px rgba(44, 95, 138, 0.08); }
        .dark .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .drag-handle { cursor: grab; touch-action: none; }
        [x-cloak] { display: none !important; }
        
        #map-container { height: calc(100vh - 280px); width: 100%; border-radius: 16px; z-index: 1; }
        .custom-marker { background-color: #2C5F8A; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        .route-line-wrapper { position: absolute; left: 20px; top: 70px; height: 40px; width: 2px; background-color: #cbd5e1; z-index: 0; display: flex; align-items: center; justify-content: center; }
        .dark .route-line-wrapper { background-color: #4b5563; }
        
        .transit-badge { background-color: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 2px 8px; font-size: 10px; color: #64748b; display: flex; align-items: center; gap: 4px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); white-space: nowrap; z-index: 10; }
        .dark .transit-badge { background-color: #1f2937; border-color: #374151; color: #9ca3af; }
        
        .pie-chart { width: 120px; height: 120px; border-radius: 50%; position: relative; }
        .pie-chart::after { content: ""; position: absolute; inset: 30px; background: #fff; border-radius: 50%; }
        .dark .pie-chart::after { background: #25262b; }
        
        /* 探索頁按鈕 */
        .explore-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.2s; border: 1px solid #f1f5f9; }
        .dark .explore-btn { background: #25262b; border-color: #374151; }
        .explore-btn:active { transform: scale(0.95); background: #f8fafc; }
    </style>
</head>
<body x-data="travelApp()" :class="{'dark': isDarkMode}" class="bg-warm text-gray-800 dark:bg-darkBg dark:text-darkText transition-colors duration-300">

    <div class="bg-white dark:bg-darkCard pb-2 relative transition-colors duration-300">
        <div class="relative w-full h-64 bg-gray-200 dark:bg-gray-700 overflow-hidden group">
            <img :src="bannerImage" class="w-full h-full object-cover transition-transform duration-700 hover:scale-105" x-show="bannerImage">
            <div x-show="!bannerImage" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pt-10">
                <i class="fas fa-image text-3xl mb-2"></i><span class="text-xs">點擊上傳封面</span>
            </div>
            <div class="absolute top-6 right-4 safe-top z-30 flex gap-2">
                <button @click="toggleCurrency()" class="bg-black/40 backdrop-blur-md text-white px-3 py-1.5 rounded-full text-xs font-bold hover:bg-fuji border border-white/20 shadow-lg"><span x-text="currency"></span></button>
                <button @click="toggleDarkMode()" class="bg-black/40 backdrop-blur-md text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-yellow-500 border border-white/20 shadow-lg"><i class="fas" :class="isDarkMode ? 'fa-sun' : 'fa-moon'"></i></button>
                <button @click="shareApp()" class="bg-black/40 backdrop-blur-md text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-blue-500 border border-white/20 shadow-lg"><i class="fas fa-share-square"></i></button>
            </div>
            <label class="absolute bottom-3 right-3 z-20 bg-black/50 text-white px-3 py-1.5 rounded-full text-xs backdrop-blur-sm cursor-pointer hover:bg-black/70 flex items-center gap-2 border border-white/10">
                <i class="fas fa-camera"></i><span>封面</span><input type="file" accept="image/*" class="hidden" @change="handleBannerUpload">
            </label>
        </div>
        <div class="px-5 py-4">
            <h1 class="text-2xl font-bold text-fuji dark:text-blue-300 tracking-wide mb-1">東京富士冬日旅</h1>
            <div class="relative group">
                <textarea x-model="appInfo" @input="saveAppInfo" rows="1" class="w-full text-xs text-gray-500 dark:text-gray-400 bg-transparent border border-transparent hover:border-gray-200 dark:hover:border-gray-600 focus:border-fuji rounded p-1 outline-none resize-none" placeholder="輸入備註..."></textarea>
                <i class="fas fa-pen absolute right-2 top-2 text-gray-300 opacity-0 group-hover:opacity-100 pointer-events-none"></i>
            </div>
        </div>
    </div>

    <div class="sticky top-0 z-40 bg-white/95 dark:bg-darkCard/95 backdrop-blur-md shadow-sm border-b border-gray-100 dark:border-gray-700 transition-colors duration-300">
        <div x-show="currentTab === 'itinerary'" class="flex items-center px-2">
            <div class="flex overflow-x-auto hide-scrollbar py-3 px-2 gap-3 flex-1">
                <template x-for="(day, index) in days" :key="index">
                    <div @click="changeDay(index)" 
                         :class="{'bg-fuji text-white shadow-md scale-105': selectedDayIdx === index, 'bg-gray-50 text-gray-400 border border-gray-100 dark:bg-gray-800 dark:border-gray-700': selectedDayIdx !== index}"
                         class="flex-shrink-0 w-14 h-16 rounded-xl flex flex-col items-center justify-center transition-all duration-200 cursor-pointer">
                        <span class="text-[9px] font-bold tracking-wider opacity-80" x-text="day.dateStr"></span>
                        <span class="text-lg font-bold" x-text="day.dayNum"></span>
                        <span class="text-[9px]" x-show="selectedDayIdx === index" x-text="day.weekday"></span>
                    </div>
                </template>
            </div>
            <div class="flex items-center gap-1 border-l border-gray-200 dark:border-gray-700 pl-2 ml-1">
                <button @click="toggleViewMode()" :class="viewMode==='map'?'text-fuji':'text-gray-400'" class="p-2 hover:text-fuji transition flex flex-col items-center"><i class="fas" :class="viewMode==='map'?'fa-map':'fa-map-marked'"></i><span class="text-[9px] font-bold">地圖</span></button>
                <button @click="openSwapModal()" class="p-2 text-gray-400 hover:text-fuji transition flex flex-col items-center"><i class="fas fa-exchange-alt"></i><span class="text-[9px] font-bold">調動</span></button>
            </div>
        </div>
        <div x-show="currentTab !== 'itinerary'" class="py-4 px-5 text-center font-bold text-fuji dark:text-blue-300"><span x-text="getTabTitle()"></span></div>
    </div>

    <main class="pt-4 px-4 min-h-screen">

        <div x-show="currentTab === 'itinerary'" x-transition.opacity>
            <div x-show="viewMode === 'list'" class="mb-6 bg-gradient-to-r from-blue-50 to-white dark:from-gray-800 dark:to-gray-700 p-4 rounded-2xl border border-blue-100 dark:border-gray-600 flex items-start gap-4 shadow-sm cursor-pointer" @click="openLocationWeather(currentDayData.region)">
                <div class="text-3xl text-fuji dark:text-blue-300 mt-1"><i :class="getWeatherIcon(selectedDayIdx)"></i></div>
                <div>
                    <h3 class="font-bold text-fuji dark:text-blue-300 text-sm mb-1 flex items-center gap-2"><span x-text="currentDayData.region + ' 預測天氣'"></span><span class="text-[10px] bg-white dark:bg-gray-600 border border-blue-200 dark:border-gray-500 text-blue-400 dark:text-blue-200 px-2 rounded-full flex items-center gap-1"><i class="fas fa-search text-[8px]"></i> 查詢</span></h3>
                    <p class="text-xs text-gray-600 dark:text-gray-300 leading-relaxed"><span x-text="currentDayData.weatherAdvice"></span><span class="text-[10px] text-gray-400 mt-1 block">均溫: <span x-text="getTemp(selectedDayIdx).min"></span>°~<span x-text="getTemp(selectedDayIdx).max"></span>° | 降雪: <span x-text="getSnowProb(selectedDayIdx)"></span>%</span></p>
                </div>
            </div>

            <div x-show="viewMode === 'list'" id="itinerary-list" class="space-y-0 pb-20">
                <template x-for="(spot, index) in currentDayData.spots" :key="spot.id">
                    <div class="relative group">
                        <div x-show="index < currentDayData.spots.length - 1" class="absolute left-[26px] top-full h-8 w-0.5 bg-gray-300 dark:bg-gray-600 z-0 flex items-center justify-center" style="height: 40px;">
                            <div class="transit-badge z-10" @click="editTransit(spot, currentDayData.spots[index+1])">
                                <i :class="getTransitIcon(spot.transitType)"></i><span x-text="spot.transitTime || '設定'"></span>
                            </div>
                            <button @click="navigateBetween(spot, currentDayData.spots[index+1])" class="absolute left-14 bg-gray-100 dark:bg-gray-700 text-fuji text-[10px] px-2 py-1 rounded-full shadow-sm hover:bg-gray-200 flex items-center gap-1 w-max"><i class="fas fa-directions"></i> 路線</button>
                        </div>

                        <div :data-id="spot.id" class="bg-white dark:bg-darkCard rounded-2xl p-4 card-shadow relative z-10 border border-transparent dark:border-gray-700 transition-colors">
                            <div class="flex justify-between items-center mb-2 border-b border-gray-100 dark:border-gray-700 pb-2">
                                <div class="flex items-center gap-2"><span class="text-sm font-bold text-fuji dark:text-blue-300 font-mono" x-text="spot.time || '--:--'"></span><span :class="getSpotClass(spot.type)" class="text-[10px] px-2 py-0.5 rounded text-white font-bold flex items-center gap-1"><i :class="getSpotIcon(spot.type)"></i><span x-text="spot.typeLabel"></span></span></div>
                                <div class="flex items-center gap-1"><div x-show="spot.cost > 0" class="text-xs font-bold text-accent mr-2"><span x-show="spot.includeInBudget" class="text-[9px] bg-gray-100 dark:bg-gray-700 text-gray-500 px-1 rounded mr-1"><i class="fas fa-calculator"></i></span><span x-text="formatMoney(spot.cost)"></span></div><button @click="editSpot(spot)" class="text-gray-300 hover:text-fuji px-2"><i class="fas fa-pen text-xs"></i></button><div class="drag-handle text-gray-300 p-1 cursor-move"><i class="fas fa-grip-lines"></i></div></div>
                            </div>
                            <div class="flex gap-4"><div class="w-14 h-14 bg-gray-100 dark:bg-gray-700 rounded-xl flex-shrink-0 overflow-hidden relative shadow-sm"><img :src="getImage(spot)" class="w-full h-full object-cover" alt="spot"></div><div class="flex-1"><div class="flex items-start justify-between"><input type="text" x-model="spot.name" class="w-full font-bold text-gray-800 dark:text-gray-100 text-base leading-tight bg-transparent border-b border-transparent focus:border-gray-200 dark:focus:border-gray-600 outline-none mb-1"><button @click="openGuideForSpot(spot)" class="text-xs text-gray-400 hover:text-fuji ml-2"><i class="fas fa-info-circle"></i></button></div><div class="mt-1 flex gap-2"><a :href="getMapLink(spot)" target="_blank" class="text-[10px] text-blue-500 dark:text-blue-400 flex items-center gap-1 hover:underline"><i class="fas fa-map-marker-alt"></i> 導航</a></div><textarea x-model="spot.desc" rows="1" class="w-full text-xs text-gray-500 dark:text-gray-400 mt-1 bg-transparent border-none outline-none resize-none p-0" placeholder="備註..."></textarea></div></div>
                            <button @click="removeSpot(index)" class="absolute -right-2 -top-2 w-6 h-6 bg-red-100 text-red-500 rounded-full text-xs opacity-0 group-hover:opacity-100 transition shadow-sm flex items-center justify-center"><i class="fas fa-times"></i></button>
                        </div>
                        <div x-show="index < currentDayData.spots.length - 1" class="h-10"></div>
                    </div>
                </template>
                <button @click="openSpotModal()" class="w-full mt-4 py-3 bg-white dark:bg-darkCard border-2 border-dashed border-fuji dark:border-blue-700 text-fuji dark:text-blue-300 rounded-xl font-bold shadow-sm hover:bg-blue-50 dark:hover:bg-gray-800 flex items-center justify-center gap-2"><i class="fas fa-plus-circle"></i> 新增行程景點</button>
            </div>

            <div x-show="viewMode === 'map'" class="relative h-full w-full">
                <div id="map-container" class="shadow-inner border border-gray-200 dark:border-gray-700"></div>
                <div x-show="mapSelectedSpot" x-transition.move.bottom class="fixed bottom-24 left-4 right-4 bg-white dark:bg-darkCard p-4 rounded-2xl shadow-2xl z-[1000] border border-gray-100 dark:border-gray-600"><div class="flex gap-4"><div class="w-16 h-16 bg-gray-100 rounded-xl overflow-hidden flex-shrink-0"><img :src="mapSelectedSpot?.img || 'icon.png'" class="w-full h-full object-cover"></div><div class="flex-1"><div class="flex justify-between items-start"><h3 class="font-bold text-gray-800 dark:text-white text-lg leading-tight" x-text="mapSelectedSpot?.name"></h3><button @click="mapSelectedSpot = null" class="text-gray-400"><i class="fas fa-times"></i></button></div><p class="text-xs text-gray-500 dark:text-gray-400 mt-1 line-clamp-2" x-text="mapSelectedSpot?.desc"></p><div class="flex gap-2 mt-2"><a :href="getMapLink(mapSelectedSpot)" target="_blank" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-lg font-bold">導航</a></div></div></div></div>
            </div>
            <div class="h-24"></div> 
        </div>

        <div x-show="currentTab === 'wallet'" x-transition.opacity>
            <div class="bg-gradient-to-br from-fuji to-blue-600 dark:from-gray-800 dark:to-gray-900 rounded-2xl p-5 text-white shadow-lg mb-6 relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div><div class="text-xs text-blue-100 opacity-80 mb-1">攜帶現金</div><div class="flex items-center gap-2"><span class="text-lg">¥</span><input type="number" x-model.number="walletData.initialCash" class="bg-transparent text-2xl font-bold w-32 outline-none border-b border-white/30 focus:border-white"></div></div>
                    <div class="text-right"><div class="text-xs text-blue-100 opacity-80 mb-1">匯率</div><div class="flex items-center justify-end gap-2"><input type="number" step="0.001" x-model.number="walletData.rate" class="w-12 bg-transparent text-right font-bold outline-none border-b border-white/30 focus:border-white"><button @click="fetchRate()" class="text-white/80 hover:text-white"><i class="fas fa-sync-alt" :class="{'fa-spin': rateLoading}"></i></button></div></div>
                </div>
                <div class="pt-4 border-t border-white/20 flex justify-between items-end">
                    <div><div class="text-xs text-blue-200">剩餘</div><div class="text-3xl font-bold" x-text="formatMoney(remainingCash)"></div></div>
                    <div class="text-right"><div class="text-xs text-blue-200">已支出</div><div class="text-lg font-bold opacity-90" x-text="formatMoney(totalSpent)"></div></div>
                </div>
            </div>

            <div class="bg-white dark:bg-darkCard rounded-3xl shadow-lg border border-gray-100 dark:border-gray-700 overflow-hidden mb-6">
                <div class="bg-gray-50 dark:bg-gray-800 p-4 text-right border-b border-gray-100 dark:border-gray-700">
                    <div class="text-xs text-gray-400 h-4" x-text="calc.equation"></div>
                    <div class="text-3xl font-bold text-gray-800 dark:text-white truncate" x-text="calc.display || '0'"></div>
                    <div class="text-xs text-fuji dark:text-blue-300 mt-1" x-show="calc.display && !isNaN(calc.display)">≈ <span x-text="formatMoney(parseFloat(calc.display), true)"></span></div>
                </div>
                <div class="p-3 grid grid-cols-3 gap-2 bg-white dark:bg-darkCard">
                    <input type="text" x-model="calc.desc" placeholder="品項名稱" class="col-span-2 bg-gray-50 dark:bg-gray-700 dark:text-white px-3 py-2 rounded-xl text-sm outline-none focus:ring-1 focus:ring-fuji">
                    <select x-model="calc.category" class="bg-gray-50 dark:bg-gray-700 dark:text-white px-2 py-2 rounded-xl text-xs outline-none"><template x-for="cat in budgetCategories"><option :value="cat" x-text="cat"></option></template></select>
                </div>
                <div class="grid grid-cols-4 gap-1 p-2 bg-gray-50 dark:bg-gray-900/50">
                    <button @click="handleCalc('C')" class="h-14 rounded-xl font-bold text-lg bg-calcFunc dark:bg-calcFuncDark text-accent transition active:scale-95">AC</button>
                    <button @click="handleCalc('back')" class="h-14 rounded-xl font-bold text-lg bg-calcFunc dark:bg-calcFuncDark text-gray-600 dark:text-gray-300 transition active:scale-95"><i class="fas fa-backspace"></i></button>
                    <button @click="handleCalc('%')" class="h-14 rounded-xl font-bold text-lg bg-calcFunc dark:bg-calcFuncDark text-gray-600 dark:text-gray-300 transition active:scale-95">%</button>
                    <button @click="handleCalc('/')" class="h-14 rounded-xl font-bold text-lg bg-calcOp dark:bg-calcOpDark text-orange-500 transition active:scale-95">÷</button>
                    <button @click="handleCalc('7')" class="h-14 rounded-xl font-bold text-lg bg-calcNum dark:bg-calcNumDark text-gray-700 dark:text-gray-200 transition active:scale-95">7</button>
                    <button @click="handleCalc('8')" class="h-14 rounded-xl font-bold text-lg bg-calcNum dark:bg-calcNumDark text-gray-700 dark:text-gray-200 transition active:scale-95">8</button>
                    <button @click="handleCalc('9')" class="h-14 rounded-xl font-bold text-lg bg-calcNum dark:bg-calcNumDark text-gray-700 dark:text-gray-200 transition active:scale-95">9</button>
                    <button @click="handleCalc('*')" class="h-14 rounded-xl font-bold text-lg bg-calcOp dark:bg-calcOpDark text-orange-500 transition active:scale-95">×</button>
                    <button @click="handleCalc('4')" class="h-14 rounded-xl font-bold text-lg bg-calcNum dark:bg-calcNumDark text-gray-700 dark:text-gray-200 transition active:scale-95">4</button>
                    <button @click="handleCalc('5')" class="h-14 rounded-xl font-bold text-lg bg-calcNum dark:bg-calcNumDark text-gray-700 dark:text-gray-200 transition active:scale-95">5</button>
                    <button @click="handleCalc('6')" class="h-14 rounded-xl font-bold text-lg bg-calcNum dark:bg-calcNumDark text-gray-700 dark:text-gray-200 transition active:scale-95">6</button>
                    <button @click="handleCalc('-')" class="h-14 rounded-xl font-bold text-lg bg-calcOp dark:bg-calcOpDark text-orange-500 transition active:scale-95">-</button>
                    <button @click="handleCalc('1')" class="h-14 rounded-xl font-bold text-lg bg-calcNum dark:bg-calcNumDark text-gray-700 dark:text-gray-200 transition active:scale-95">1</button>
                    <button @click="handleCalc('2')" class="h-14 rounded-xl font-bold text-lg bg-calcNum dark:bg-calcNumDark text-gray-700 dark:text-gray-200 transition active:scale-95">2</button>
                    <button @click="handleCalc('3')" class="h-14 rounded-xl font-bold text-lg bg-calcNum dark:bg-calcNumDark text-gray-700 dark:text-gray-200 transition active:scale-95">3</button>
                    <button @click="handleCalc('+')" class="h-14 rounded-xl font-bold text-lg bg-calcOp dark:bg-calcOpDark text-orange-500 transition active:scale-95">+</button>
                    <button @click="handleCalc('0')" class="h-14 rounded-xl font-bold text-lg bg-calcNum dark:bg-calcNumDark text-gray-700 dark:text-gray-200 transition active:scale-95">0</button>
                    <button @click="handleCalc('.')" class="h-14 rounded-xl font-bold text-lg bg-calcNum dark:bg-calcNumDark text-gray-700 dark:text-gray-200 transition active:scale-95">.</button>
                    <button @click="handleCalc('=')" class="h-14 rounded-xl font-bold text-lg bg-fuji text-white transition active:scale-95">=</button>
                    <button @click="handleCalc('Save')" class="h-14 rounded-xl font-bold text-sm bg-fuji text-white transition active:scale-95"><i class="fas fa-save"></i> 記帳</button>
                </div>
            </div>

            <div class="bg-white dark:bg-darkCard rounded-2xl p-5 shadow-sm mb-6 flex items-center justify-between">
                <div class="pie-chart shadow-inner" :style="pieChartStyle"></div>
                <div class="flex-1 pl-6 space-y-1">
                    <h4 class="text-xs font-bold text-gray-400 mb-2">支出分類統計</h4>
                    <template x-for="cat in sortedCategories" :key="cat.name">
                        <div class="flex items-center justify-between text-xs" x-show="cat.value > 0">
                            <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full" :class="getBudgetColor(cat.name)"></div><span class="text-gray-600 dark:text-gray-300" x-text="cat.name"></span></div>
                            <span class="font-bold text-gray-800 dark:text-gray-100" x-text="Math.round(cat.percent) + '%'"></span>
                        </div>
                    </template>
                </div>
            </div>
            
            <div class="space-y-3">
                <h3 class="font-bold text-gray-800 dark:text-white px-2">支出紀錄</h3>
                <div x-show="itinerarySpent > 0" class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl shadow-sm flex items-center justify-between border-l-4 border-blue-500">
                    <div><div class="font-bold text-fuji dark:text-blue-300 text-sm">行程預定花費 (自動同步)</div></div>
                    <div class="text-right"><div class="font-bold text-fuji dark:text-blue-300" x-text="formatMoney(itinerarySpent)"></div></div>
                </div>
                <template x-for="(tx, index) in walletData.transactions" :key="index">
                    <div class="bg-white dark:bg-darkCard p-3 rounded-xl shadow-sm flex items-center justify-between border-l-4" :class="getBudgetBorderColor(tx.category)">
                        <div><div class="font-bold text-gray-800 dark:text-gray-200 text-sm" x-text="tx.desc"></div><div class="text-[10px] text-gray-400" x-text="tx.category"></div></div>
                        <div class="text-right"><div class="font-bold text-fuji dark:text-blue-300" x-text="formatMoney(tx.amount)"></div><button @click="removeTransaction(index)" class="text-gray-300 hover:text-red-400 text-xs"><i class="fas fa-trash-alt"></i></button></div>
                    </div>
                </template>
            </div>
            <div class="h-24"></div>
        </div>

        <div x-show="currentTab === 'guide'" x-transition.opacity>
            <div class="bg-white dark:bg-darkCard rounded-2xl p-5 shadow-md mb-6 relative border border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">
                    <div class="flex items-center gap-2"><i class="fas fa-book-reader text-fuji dark:text-blue-300 text-lg"></i><h3 class="font-bold text-gray-800 dark:text-white text-lg">景點介紹</h3></div>
                    <button @click="openGuideModal()" class="text-xs bg-fuji text-white px-2 py-1 rounded shadow"><i class="fas fa-plus"></i> 新增</button>
                </div>
                <div class="space-y-4">
                    <template x-for="(guide, idx) in guideData" :key="idx">
                        <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-xl relative group border border-gray-100 dark:border-gray-700">
                            <div class="flex gap-3">
                                <div x-show="guide.img" class="w-16 h-16 flex-shrink-0 bg-gray-200 rounded-lg overflow-hidden cursor-pointer" @click="openLightbox(guide.img)"><img :src="guide.img" class="w-full h-full object-cover"></div>
                                <div class="flex-1"><h4 class="font-bold text-fuji dark:text-blue-300 text-sm mb-1" x-text="guide.title"></h4><p class="text-xs text-gray-600 dark:text-gray-300 leading-relaxed mb-2" x-text="guide.desc"></p><button @click="addSpotFromGuide(guide)" class="text-[10px] bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-200 px-2 py-1 rounded"><i class="fas fa-plus"></i> 加入行程</button></div>
                            </div>
                            <div class="absolute top-2 right-2 flex gap-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition"><button @click="openGuideModal(guide, idx)" class="text-gray-400 hover:text-fuji p-1 bg-white/80 rounded"><i class="fas fa-pen text-xs"></i></button><button @click="removeGuide(idx)" class="text-gray-400 hover:text-red-400 p-1 bg-white/80 rounded"><i class="fas fa-trash text-xs"></i></button></div>
                        </div>
                    </template>
                </div>
            </div>
            <div class="space-y-4 mb-6"><template x-for="(block, bIdx) in memoBlocks" :key="bIdx"><div class="bg-yellow-50 dark:bg-yellow-900/10 rounded-2xl shadow-sm border border-yellow-100 dark:border-yellow-900/30 overflow-hidden"><div class="p-4 flex items-center justify-between cursor-pointer hover:bg-yellow-100/50 dark:hover:bg-yellow-900/20 transition" @click="block.isOpen = !block.isOpen"><div class="flex items-center gap-2 flex-1"><i class="fas fa-chevron-right text-yellow-600 text-xs transition-transform duration-200" :class="{'rotate-90': block.isOpen}"></i><input type="text" x-model="block.title" @click.stop class="bg-transparent font-bold text-yellow-800 dark:text-yellow-500 outline-none w-full"></div><div class="text-xs text-yellow-600 mr-2" x-show="!block.isOpen"><span x-text="block.items.length"></span> 項</div><button @click.stop="removeMemoBlock(bIdx)" class="text-gray-300 hover:text-red-400"><i class="fas fa-trash-alt text-xs"></i></button></div><div x-show="block.isOpen" x-collapse><div class="px-4 pb-4 space-y-1"><template x-for="(item, iIdx) in block.items" :key="iIdx"><div class="flex items-start gap-2 py-1 group"><input type="checkbox" x-model="item.checked" class="mt-1 w-4 h-4 rounded text-fuji"><input type="text" x-model="item.text" class="flex-1 ml-2 bg-transparent text-sm outline-none border-b border-transparent focus:border-yellow-300"><button @click="removeMemoItem(bIdx, iIdx)" class="text-gray-300 hover:text-red-400 ml-2"><i class="fas fa-trash-alt text-xs"></i></button></div></template><div class="flex gap-2 mt-2 pt-2 border-t border-yellow-200/50"><input type="text" x-model="block.newItemText" @keydown.enter="addMemoItem(bIdx, 'todo')" placeholder="新增項目..." class="flex-1 bg-white/50 dark:bg-black/10 border-none rounded-lg px-2 py-1 text-sm outline-none"><button @click="addMemoItem(bIdx, 'todo')" class="text-yellow-600 p-1"><i class="fas fa-check-square"></i></button></div></div></div></div></template><button @click="addMemoBlock()" class="w-full py-3 border-2 border-dashed border-yellow-200 text-yellow-500 rounded-xl font-bold"><i class="fas fa-folder-plus mr-2"></i> 新增分類清單</button></div>
            <div class="h-24"></div>
        </div>

        <div x-show="currentTab === 'explore'" x-transition.opacity>
            <div class="bg-gradient-to-r from-blue-500 to-fuji rounded-2xl p-5 text-white shadow-lg mb-6 relative overflow-hidden" x-init="fetchRealTimeWeather()">
                <div class="relative z-10">
                    <div class="flex justify-between items-start">
                        <div><div class="text-xs opacity-80 mb-1 flex items-center gap-1"><i class="fas fa-location-arrow"></i> 目前位置</div><div class="text-2xl font-bold">實時天氣</div></div>
                        <button @click="fetchRealTimeWeather()" class="text-white/80 hover:text-white"><i class="fas fa-sync-alt" :class="{'fa-spin': realTimeWeather.loading}"></i></button>
                    </div>
                    <div class="mt-4 flex items-center gap-4" x-show="!realTimeWeather.loading && realTimeWeather.temp">
                        <div class="text-5xl font-bold"><span x-text="realTimeWeather.temp"></span>°</div>
                        <div><div class="text-lg font-bold" x-text="realTimeWeather.desc"></div><div class="text-xs opacity-80">體感 <span x-text="realTimeWeather.feelsLike"></span>°</div></div>
                    </div>
                    <div class="mt-4 text-sm opacity-80" x-show="realTimeWeather.loading">定位載入中...</div>
                    <div class="mt-4 text-sm text-red-200" x-show="realTimeWeather.error" x-text="realTimeWeather.error"></div>
                </div>
                <i class="fas fa-cloud absolute -right-4 -bottom-4 text-9xl text-white/10"></i>
            </div>
            
            <h3 class="font-bold text-gray-800 dark:text-white px-1 mb-2">周邊快搜</h3>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button @click="searchNearby('親子餐廳')" class="explore-btn text-orange-500 hover:bg-orange-50"><i class="fas fa-utensils text-2xl mb-1"></i><span class="text-xs font-bold text-gray-600 dark:text-gray-300">親子餐廳</span></button>
                <button @click="searchNearby('室內景點')" class="explore-btn text-blue-500 hover:bg-blue-50"><i class="fas fa-umbrella-beach text-2xl mb-1"></i><span class="text-xs font-bold text-gray-600 dark:text-gray-300">室內景點</span></button>
                <button @click="searchNearby('便利商店')" class="explore-btn text-green-500 hover:bg-green-50"><i class="fas fa-store text-2xl mb-1"></i><span class="text-xs font-bold text-gray-600 dark:text-gray-300">便利商店</span></button>
                <button @click="searchNearby('廁所')" class="explore-btn text-gray-500 hover:bg-gray-50"><i class="fas fa-restroom text-2xl mb-1"></i><span class="text-xs font-bold text-gray-600 dark:text-gray-300">急用廁所</span></button>
            </div>
            
            <h3 class="font-bold text-gray-800 dark:text-white px-1 mb-2">推薦雨備 (東京/富士)</h3>
            <div class="space-y-3">
                <template x-for="plan in rainyPlans">
                    <div class="bg-white dark:bg-darkCard p-3 rounded-xl shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-50" @click="openMapSearch(plan.name)">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-500"><i class="fas fa-umbrella"></i></div>
                            <div><div class="font-bold text-gray-800 dark:text-gray-200 text-sm" x-text="plan.name"></div><div class="text-[10px] text-gray-400" x-text="plan.desc"></div></div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </div>
                </template>
            </div>
            <div class="h-24"></div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 dark:bg-darkCard/95 backdrop-blur-xl border-t border-gray-200 dark:border-gray-700 transition-colors z-40 safe-bottom">
        <div class="grid grid-cols-4 items-center h-16 max-w-md mx-auto">
            <button @click="currentTab='itinerary'" :class="currentTab==='itinerary'?'text-fuji dark:text-blue-300':'text-gray-400'" class="flex flex-col items-center justify-center h-full active:scale-95"><i class="fas fa-map-marked-alt text-xl mb-1"></i><span class="text-[9px] font-bold">行程</span></button>
            <button @click="currentTab='wallet'" :class="currentTab==='wallet'?'text-fuji dark:text-blue-300':'text-gray-400'" class="flex flex-col items-center justify-center h-full active:scale-95"><i class="fas fa-wallet text-xl mb-1"></i><span class="text-[9px] font-bold">錢包</span></button>
            <button @click="currentTab='guide'" :class="currentTab==='guide'?'text-fuji dark:text-blue-300':'text-gray-400'" class="flex flex-col items-center justify-center h-full active:scale-95"><i class="fas fa-book-open text-xl mb-1"></i><span class="text-[9px] font-bold">指南</span></button>
            <button @click="currentTab='explore'" :class="currentTab==='explore'?'text-fuji dark:text-blue-300':'text-gray-400'" class="flex flex-col items-center justify-center h-full active:scale-95"><i class="fas fa-compass text-xl mb-1"></i><span class="text-[9px] font-bold">探索</span></button>
        </div>
    </nav>

    <div x-show="showSwapModal" x-cloak class="fixed inset-0 z-[60] flex items-center justify-center px-4"><div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showSwapModal=false"></div><div class="bg-white dark:bg-darkCard w-full max-w-xs rounded-3xl p-5 relative z-10 shadow-xl border border-white/10 text-center"><h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">調動行程</h3><p class="text-sm text-gray-500 mb-4">將 <span class="font-bold text-fuji" x-text="days[selectedDayIdx].dateStr"></span> 的所有行程與...</p><div class="grid grid-cols-4 gap-2 mb-4"><template x-for="(day, idx) in days" :key="idx"><button @click="swapDayWith(idx)" x-show="idx !== selectedDayIdx" class="py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-xs font-bold hover:bg-fuji hover:text-white transition" x-text="day.dateStr"></button></template></div><button @click="showSwapModal=false" class="text-sm text-gray-400 underline">取消</button></div></div>
    <div x-show="showTransitModal" x-cloak class="fixed inset-0 z-[60] flex items-center justify-center px-4"><div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closeTransitModal()"></div><div class="bg-white dark:bg-darkCard w-full max-w-sm rounded-3xl p-5 relative z-10 shadow-xl border border-white/10"><h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">設定路程</h3><div class="flex justify-between gap-2 mb-4"><button @click="transitEdit.type='walk'" :class="transitEdit.type==='walk'?'bg-fuji text-white':'bg-gray-100 dark:bg-gray-700 text-gray-500'" class="flex-1 py-2 rounded-xl text-xs font-bold transition"><i class="fas fa-walking"></i> 走路</button><button @click="transitEdit.type='train'" :class="transitEdit.type==='train'?'bg-fuji text-white':'bg-gray-100 dark:bg-gray-700 text-gray-500'" class="flex-1 py-2 rounded-xl text-xs font-bold transition"><i class="fas fa-subway"></i> 地鐵</button><button @click="transitEdit.type='car'" :class="transitEdit.type==='car'?'bg-fuji text-white':'bg-gray-100 dark:bg-gray-700 text-gray-500'" class="flex-1 py-2 rounded-xl text-xs font-bold transition"><i class="fas fa-car"></i> 開車</button></div><div class="mb-4"><label class="block text-xs text-gray-500 mb-1">預估時間 (例如: 15 min)</label><input type="text" x-model="transitEdit.time" class="w-full bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl px-3 py-2 outline-none focus:border-fuji"></div><div class="flex gap-3"><button @click="closeTransitModal()" class="flex-1 py-2 bg-gray-100 dark:bg-gray-700 text-gray-500 rounded-xl font-bold text-sm">取消</button><button @click="saveTransit()" class="flex-1 py-2 bg-fuji text-white rounded-xl font-bold text-sm">確認</button></div></div></div>
    <div x-show="showSpotModal" x-cloak class="fixed inset-0 z-[60] flex items-center justify-center px-4"><div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closeSpotModal()"></div><div class="bg-white dark:bg-darkCard w-full max-w-md rounded-3xl p-6 relative z-10 shadow-2xl max-h-[90vh] overflow-y-auto border border-white/10"><h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2"><i class="fas fa-map-pin text-fuji dark:text-blue-400"></i> <span x-text="editingSpotId ? '編輯行程' : '新增行程'"></span></h3><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">時間</label><input type="time" x-model="modalSpot.time" class="w-full bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl px-3 py-2 outline-none focus:border-fuji"></div><div class="flex gap-2"><div class="w-1/3"><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">分類</label><select x-model="modalSpot.type" class="w-full bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl px-2 py-2.5 text-sm outline-none focus:border-fuji"><option value="spot">景點</option><option value="food">餐廳</option><option value="shop">購物</option><option value="hotel">住宿</option><option value="trans">交通</option><option value="play">樂園</option></select></div><div class="flex-1"><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">名稱</label><input type="text" x-model="modalSpot.name" class="w-full bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl px-3 py-2 text-sm outline-none focus:border-fuji" placeholder="地點名稱"></div></div><div class="flex items-end gap-3 bg-blue-50 dark:bg-gray-800 p-3 rounded-xl border border-blue-100 dark:border-gray-700"><div class="flex-1"><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">花費 (JPY)</label><input type="number" x-model.number="modalSpot.cost" class="w-full bg-white dark:bg-gray-700 dark:text-white border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-1.5 text-sm outline-none"></div><label class="flex items-center gap-2 mb-2 cursor-pointer"><input type="checkbox" x-model="modalSpot.includeInBudget" class="w-4 h-4 rounded text-fuji focus:ring-fuji border-gray-300"><span class="text-xs text-gray-600 dark:text-gray-300 font-bold">加入預算</span></label></div><div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700"><div class="flex gap-4 mb-2"><label class="flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400 cursor-pointer"><input type="radio" value="auto" x-model="modalSpot.locationType" class="text-fuji focus:ring-fuji"> 自動地圖</label><label class="flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400 cursor-pointer"><input type="radio" value="manual" x-model="modalSpot.locationType" class="text-fuji focus:ring-fuji"> 手動網址</label></div><div x-show="modalSpot.locationType === 'manual'"><input type="text" x-model="modalSpot.location" placeholder="輸入 Google Maps 連結" class="w-full bg-white dark:bg-gray-700 dark:text-white border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-1.5 text-xs outline-none"></div></div><div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">備註</label><textarea x-model="modalSpot.desc" rows="3" class="w-full bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl px-3 py-2 text-sm outline-none focus:border-fuji resize-none"></textarea></div><div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">封面圖片</label><label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition relative overflow-hidden"><img x-show="modalSpot.imgDisplay" :src="modalSpot.imgDisplay" class="absolute inset-0 w-full h-full object-cover"><div x-show="!modalSpot.imgDisplay" class="flex flex-col items-center justify-center pt-5 pb-6"><i class="fas fa-camera text-gray-400 text-2xl mb-2"></i><p class="text-xs text-gray-500">點擊拍照或上傳</p></div><input type="file" class="hidden" accept="image/*" @change="handleSpotImageUpload"></label></div></div><div class="flex gap-3 mt-6"><button @click="closeSpotModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 rounded-xl font-bold text-sm">取消</button><button @click="saveSpot()" class="flex-1 py-3 bg-fuji text-white rounded-xl font-bold text-sm shadow-md">確認儲存</button></div></div></div>
    <div x-show="showGuideModal" x-cloak class="fixed inset-0 z-[60] flex items-center justify-center px-4"><div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closeGuideModal()"></div><div class="bg-white dark:bg-darkCard w-full max-w-md rounded-3xl p-6 relative z-10 shadow-2xl max-h-[90vh] overflow-y-auto border border-white/10"><h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">編輯指南景點</h3><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">標題</label><input type="text" x-model="modalGuide.title" class="w-full bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl px-3 py-2 outline-none focus:border-fuji"></div><div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">描述</label><textarea x-model="modalGuide.desc" rows="4" class="w-full bg-gray-50 dark:bg-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl px-3 py-2 text-sm outline-none focus:border-fuji resize-none"></textarea></div><div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">圖片</label><label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition relative overflow-hidden"><img x-show="modalGuide.img" :src="modalGuide.img" class="absolute inset-0 w-full h-full object-cover"><div x-show="!modalGuide.img" class="flex flex-col items-center justify-center pt-5 pb-6"><i class="fas fa-camera text-gray-400 text-2xl mb-2"></i><p class="text-xs text-gray-500">上傳圖片</p></div><input type="file" class="hidden" accept="image/*" @change="handleGuideImageUpload"></label></div></div><div class="flex gap-3 mt-6"><button @click="closeGuideModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 text-gray-500 rounded-xl font-bold text-sm">取消</button><button @click="saveGuide()" class="flex-1 py-3 bg-fuji text-white rounded-xl font-bold text-sm">儲存</button></div></div></div>
    <div x-show="lightboxImg" x-cloak class="fixed inset-0 z-[70] bg-black/90 flex items-center justify-center p-4 cursor-zoom-out" @click="lightboxImg = null"><img :src="lightboxImg" class="max-w-full max-h-full rounded-lg shadow-2xl"></div>

    <script>
        function travelApp() {
            return {
                currentTab: 'itinerary', selectedDayIdx: 0, viewMode: 'list', isDarkMode: false, currency: 'JPY',
                bannerImage: localStorage.getItem('trip_banner') || 'hero.jpg', appInfo: localStorage.getItem('trip_info') || '版本 1.0',
                sortableInstance: null, mapInstance: null, mapMarkers: [], mapSelectedSpot: null,
                realTimeWeather: { temp: null, desc: '', feelsLike: null, loading: false, error: null }, rateLoading: false,

                // Core
                handleBannerUpload(e) { const f = e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(ev)=>{this.bannerImage=ev.target.result;localStorage.setItem('trip_banner',this.bannerImage)};r.readAsDataURL(f);}},
                saveAppInfo() { localStorage.setItem('trip_info', this.appInfo); },
                toggleDarkMode() { this.isDarkMode = !this.isDarkMode; },
                toggleCurrency() { this.currency = this.currency === 'JPY' ? 'TWD' : 'JPY'; },
                toggleViewMode() { this.viewMode = this.viewMode === 'list' ? 'map' : 'list'; if(this.viewMode==='map') this.$nextTick(()=>this.initMap()); },
                shareApp() { if(navigator.share){navigator.share({title:'東京富士旅',url:window.location.href})}else{alert('請手動複製連結');} },
                
                // Swap
                showSwapModal: false, openSwapModal() { this.showSwapModal = true; },
                swapDayWith(targetIdx) {
                    const temp = this.itineraryData[this.selectedDayIdx];
                    this.itineraryData[this.selectedDayIdx] = this.itineraryData[targetIdx];
                    this.itineraryData[targetIdx] = temp;
                    this.showSwapModal = false;
                    alert('行程已調動！');
                },

                // Wallet
                budgetCategories: ['交通', '娛樂', '餐飲', '樂園', '飯店', '服飾', '玩具', '其他'],
                walletData: { initialCash: 245000, rate: 0.22, transactions: [] },
                calc: { display: '', equation: '', category: '餐飲', desc: '' },
                // 修正按鍵佈局
                calcButtons: ['C','⌫','%','/','7','8','9','*','4','5','6','-','1','2','3','+','0','.','=','Save'],
                
                handleCalc(btn) {
                    if(btn==='C'){this.calc.display='';this.calc.equation=''}
                    else if(btn==='⌫'){this.calc.display=this.calc.display.slice(0,-1)}
                    else if(['+','-','*','/'].includes(btn)){this.calc.display+=btn}
                    else if(btn==='%'){this.calc.display+='/100'}
                    else if(btn==='='){try{let exp=this.calc.display.replace(/(\d+)\s*-\s*(\d+)\s*\/100/g,'$1*(1-$2/100)').replace(/(\d+)\s*\+\s*(\d+)\s*\/100/g,'$1*(1+$2/100)');this.calc.display=eval(exp).toString()}catch(e){this.calc.display='Error'}}
                    else if(btn==='Save'){ if(this.calc.display && !isNaN(this.calc.display)){ this.walletData.transactions.push({id:Date.now(), desc:this.calc.desc||'一般', category:this.calc.category, amount:parseInt(this.calc.display), date:new Date().toLocaleDateString('zh-TW',{month:'numeric',day:'numeric'})}); this.calc.display=''; } }
                    else{this.calc.display+=btn}
                },
                async fetchRate() { this.rateLoading=true; try{const res=await fetch('https://api.exchangerate-api.com/v4/latest/JPY');const d=await res.json();if(d.rates.TWD)this.walletData.rate=d.rates.TWD;}catch(e){}finally{this.rateLoading=false;} },
                formatMoney(amount, isApprox=false) { if(!amount) return '0'; let val=parseFloat(amount); if(this.currency==='TWD'||isApprox) return 'NT$ '+Math.round(val*this.walletData.rate).toLocaleString(); return '¥ '+val.toLocaleString(); },
                get totalSpent() { return this.walletData.transactions.reduce((s,i)=>s+i.amount,0) + this.itinerarySpent; },
                get itinerarySpent() { let t=0; this.itineraryData.forEach(d=>{d.spots.forEach(s=>{if(s.includeInBudget&&s.cost)t+=parseInt(s.cost)})}); return t; },
                get remainingCash() { return this.walletData.initialCash - this.totalSpent; },
                get sortedCategories() { const map={}; this.walletData.transactions.forEach(t=>{map[t.category]=(map[t.category]||0)+t.amount}); this.itineraryData.forEach(d=>{d.spots.forEach(s=>{if(s.includeInBudget&&s.cost){let c='其他';if(s.type==='trans')c='交通';if(s.type==='play'||s.type==='spot')c='樂園';if(s.type==='food')c='餐飲';if(s.type==='shop')c='服飾';map[c]=(map[c]||0)+parseInt(s.cost)}})}); const total=this.totalSpent||1; return Object.keys(map).map(k=>({name:k,value:map[k],percent:(map[k]/total)*100})).sort((a,b)=>b.value-a.value); },
                get pieChartStyle() { let s='conic-gradient('; let d=0; const c={'交通':'#3b82f6','娛樂':'#facc15','餐飲':'#f97316','樂園':'#ec4899','飯店':'#6366f1','服飾':'#a855f7','玩具':'#ef4444','其他':'#9ca3af'}; this.sortedCategories.forEach((cat,i)=>{const deg=(cat.value/(this.totalSpent||1))*360;s+=`${c[cat.name]||'#ccc'} ${d}deg ${d+deg}deg`;d+=deg;if(i<this.sortedCategories.length-1)s+=', ';}); s+=')'; return s; },
                getBudgetBorderColor(c){const m={'交通':'border-blue-500','餐飲':'border-orange-500'};return m[c]||'border-gray-400'},
                getBudgetColor(c){const m={'交通':'bg-blue-500','餐飲':'bg-orange-500'};return m[c]||'bg-gray-400'},
                removeTransaction(i){if(confirm('刪除？'))this.walletData.transactions.splice(i,1)},
                isOperator(btn){return ['+','-','*','/','C','=','%'].includes(btn)},

                // Explore
                async fetchRealTimeWeather(){/*...*/}, openLocationWeather(r){window.open(`https://www.google.com/search?q=天氣+${r}`,'_blank')},
                searchNearby(keyword) { window.open(`https://www.google.com/maps/search/${keyword}`, '_blank'); },
                openMapSearch(place) { window.open(`https://www.google.com/maps/search/${place}`, '_blank'); },
                rainyPlans: [
                    { name: '池袋太陽城水族館', desc: '位於 Sunshine City 頂樓，特色是天空企鵝。' },
                    { name: 'TeamLab Planets', desc: '沈浸式光影藝術展，位於豐洲，適合全家大小。' },
                    { name: 'Aeon Mall 幕張新都心', desc: '超大型購物中心，有室內遊樂場與美食街。' }
                ],

                // Map & Nav
                getMapLink(spot) { return spot.locationType==='manual'?spot.location:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(spot.name)}`; },
                navigateBetween(start, end) { 
                    let mode='transit'; if(start.transitType==='car')mode='driving'; if(start.transitType==='walk')mode='walking';
                    window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(start.name)}&destination=${encodeURIComponent(end.name)}&travelmode=${mode}`, '_blank');
                },
                initMap() {
                    if (this.mapInstance) this.mapInstance.remove();
                    const container = document.getElementById('map-container');
                    if(!container) return;
                    const spots = this.currentDayData.spots;
                    const center = spots.length > 0 && spots[0].lat ? [spots[0].lat, spots[0].lng] : [35.6895, 139.6917];
                    this.mapInstance = L.map('map-container').setView(center, 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.mapInstance);
                    const bounds = [];
                    spots.forEach((spot, i) => {
                        if(spot.lat && spot.lng) {
                            const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="custom-marker">${i + 1}</div>`, iconSize: [24, 24], iconAnchor: [12, 12] });
                            L.marker([spot.lat, spot.lng], {icon: icon}).addTo(this.mapInstance).bindPopup(`<b>${spot.name}</b><br>${spot.desc}`).on('click', () => this.mapSelectedSpot = spot);
                            bounds.push([spot.lat, spot.lng]);
                        }
                    });
                    if(bounds.length > 0) this.mapInstance.fitBounds(bounds, {padding:[50,50]});
                },

                // Data (同前)
                days: [{ dateStr: '12/21', dayNum: 'D1', weekday: '週日' }, { dateStr: '12/22', dayNum: 'D2', weekday: '週一' }, { dateStr: '12/23', dayNum: 'D3', weekday: '週二' }, { dateStr: '12/24', dayNum: 'D4', weekday: '週三' }, { dateStr: '12/25', dayNum: 'D5', weekday: '週四' }, { dateStr: '12/26', dayNum: 'D6', weekday: '週五' }, { dateStr: '12/27', dayNum: 'D7', weekday: '週六' }, { dateStr: '12/28', dayNum: 'D8', weekday: '週日' }],
                itineraryData: [
                    { region: '千葉', weatherAdvice: "抵達日。氣溫約 9°C。", spots: [
                        { id: 101, time: '06:40', type: 'trans', typeLabel: '航班', name: '酷航 TR898', desc: 'TPE -> NRT (T1)', transitTime: '40m', transitType: 'car', cost: 0, lat: 35.7719, lng: 140.3906, img: 'd1_airport.jpg' },
                        { id: 102, time: '12:05', type: 'trans', typeLabel: '交通', name: '機場巴士 -> 海濱幕張', desc: '12號站牌搭乘', transitTime: '15m', transitType: 'train', cost: 1300, includeInBudget: true, lat: 35.6483, lng: 140.0422, img: 'icon.png' },
                        { id: 103, time: '13:00', type: 'shop', typeLabel: '購物', name: '三井 Outlet Park 幕張', desc: '午餐：Outlet 內解決。', transitTime: '25m', transitType: 'car', tags: ['Beams'], mustBuy: true, lat: 35.6486, lng: 140.0416, img: 'd1_outlet.jpg' },
                        { id: 104, time: '17:00', type: 'hotel', typeLabel: '住宿', name: '星野 1955 Tokyo Bay', desc: 'Lawson 買隔天早餐。', tags: ['Check-in'], mustEat: true, lat: 35.6372, lng: 139.9272, img: 'd1_hoshino.jpg' } 
                    ]},
                     { region: '舞濱', weatherAdvice: "迪士尼全日。氣溫 8°C。", spots: [] }, { region: '舞濱', weatherAdvice: "迪士尼海洋。氣溫 8°C。", spots: [] }, { region: '山梨', weatherAdvice: "移動至富士山。", spots: [] }, { region: '山梨', weatherAdvice: "聖誕節 @ 富士五湖。", spots: [] }, { region: '東京', weatherAdvice: "移動回東京。", spots: [] }, { region: '東京', weatherAdvice: "市區逛街。", spots: [] }, { region: '東京', weatherAdvice: "回程日。", spots: [] }
                ],
                
                // Common
                get currentDayData() { return this.itineraryData[this.selectedDayIdx]; },
                changeDay(i){ this.selectedDayIdx=i; this.$nextTick(()=>{if(this.viewMode==='map')this.initMap();else this.initSortable()}) },
                getSpotClass(t){const m={'food':'bg-tagFood','shop':'bg-tagShop','spot':'bg-tagSpot','hotel':'bg-tagHotel','trans':'bg-tagTrans','play':'bg-tagPlay'};return m[t]||'bg-fuji'},
                getSpotIcon(t){const i={'food':'fa-utensils','shop':'fa-shopping-bag','spot':'fa-camera','hotel':'fa-bed','trans':'fa-car','play':'fa-ticket-alt'};return `fas ${i[t]||'fa-map-marker-alt'}`},
                getTransitIcon(t){const i={'walk':'fa-walking','train':'fa-subway','car':'fa-car'};return `fas ${i[t]||'fa-arrow-down'}`},
                getImage(s){return s.img||'icon.png'},
                getWeatherIcon(i){return `fas ${['fa-plane','fa-sun','fa-cloud-sun','fa-snowflake','fa-snowflake','fa-cloud','fa-sun','fa-plane'][i]}`},
                getTemp(i){return [{max:11,min:5},{max:10,min:4},{max:9,min:3},{max:6,min:-2},{max:5,min:-3},{max:9,min:2},{max:12,min:6},{max:12,min:6}][i]},
                getSnowProb(i){return [10,0,10,60,80,20,0,0][i]},
                getRegion(i){return ['千葉','舞濱','舞濱','山梨','山梨','東京','東京','東京'][i]},
                removeSpot(i){if(confirm('移除？'))this.currentDayData.spots.splice(i,1)},
                initSortable(){const el=document.getElementById('itinerary-list');if(el){this.sortableInstance=new Sortable(el,{handle:'.drag-handle',animation:150,ghostClass:'sortable-ghost',onEnd:(evt)=>{const item=this.currentDayData.spots.splice(evt.oldIndex,1)[0];this.currentDayData.spots.splice(evt.newIndex,0,item)}})}},
                init(){this.$nextTick(()=>{this.initSortable(); this.fetchRate()});},
                // Modal
                showSpotModal: false, editingSpotId: null, modalSpot: {},
                showTransitModal: false, transitEdit: { start: null, end: null, time: '', type: 'train' },
                openSpotModal(s=null){if(s){this.editingSpotId=s.id;this.modalSpot={...s}}else{this.editingSpotId=null;this.modalSpot={time:'',type:'spot',name:'',cost:0,includeInBudget:false,locationType:'auto',desc:'',imgDisplay:'icon.png'}}this.showSpotModal=true},
                closeSpotModal(){this.showSpotModal=false},
                saveSpot(){ /* ... */ this.closeSpotModal(); },
                handleSpotImageUpload(e){ /* ... */ },
                editTransit(s, next){this.transitEdit={start:s,end:next,time:s.transitTime||'15m',type:s.transitType||'train'};this.showTransitModal=true},
                closeTransitModal(){this.showTransitModal=false},
                saveTransit(){this.transitEdit.start.transitTime=this.transitEdit.time;this.transitEdit.start.transitType=this.transitEdit.type;this.closeTransitModal()},
                
                // Guide
                showGuideModal: false, editingGuideIdx: null, modalGuide: {}, lightboxImg: null,
                openGuideModal(g=null,i=null){if(g){this.editingGuideIdx=i;this.modalGuide={...g}}else{this.editingGuideIdx=null;this.modalGuide={title:'',desc:'',img:''}}this.showGuideModal=true},
                closeGuideModal(){this.showGuideModal=false}, saveGuide(){if(this.editingGuideIdx!==null)this.guideData[this.editingGuideIdx]={...this.modalGuide};else this.guideData.push({...this.modalGuide});this.closeGuideModal()},
                removeGuide(i){if(confirm('刪除？'))this.guideData.splice(i,1)}, handleGuideImageUpload(e){/*...*/}, openLightbox(img){this.lightboxImg=img}, addSpotFromGuide(g){/*...*/}, openGuideForSpot(s){this.currentTab='guide'},
                memoBlocks: [{title:'必備證件',isOpen:true,newItemText:'',items:[{type:'todo',text:'護照',checked:false}]}],
                addMemoBlock(){this.memoBlocks.push({title:'新分類',isOpen:true,newItemText:'',items:[]})},
                addMemoItem(b,t){const txt=this.memoBlocks[b].newItemText.trim(); if(!txt&&t!=='text')return; this.memoBlocks[b].items.push({type:t,text:txt||'內容',checked:false}); this.memoBlocks[b].newItemText=''},
                removeMemoBlock(i){if(confirm('刪除？'))this.memoBlocks.splice(i,1)}, removeMemoItem(b,i){this.memoBlocks[b].items.splice(i,1)},
                getTabTitle(){return {wallet:'旅遊錢包',guide:'指南 & 備忘',explore:'探索 & 天氣'}[this.currentTab]||''}
            }
        }
    </script>
</body>
</html>
